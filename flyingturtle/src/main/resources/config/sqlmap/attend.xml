<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
	"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="kr.co.flyingturtle.repository.mapper.AttendMapper">
	
	<!-- 일별 출석 목록 가져오기 -->
	<select id="selectDayList" parameterType="attend" resultType="attend">
		select a.attend_no, b.name, c.code_name, a.check_in, a.check_out, a.special_note
		  from tb_attendance a
		 inner join tb_member b
			on a.member_no = b.member_no
		 inner join tb_code c
			on a.code_no = c.code_no
		 <include refid="search"></include>
		 and a.attend_reg_date>date_format(curdate(),'%Y-%m-%d')
	</select>

	<!-- 검색 -->
	<sql id="search">
		<if test="searchType =='name'">
		 	where name like CONCAT('%',#{keyword},'%')
		</if>
	</sql>
	
	<!-- 입실 체크 -->
	<select id="selectAttendCheck" parameterType="attend" resultType="int">
		select EXISTS(
			select * 
			  from tb_attendance
			 where member_no = #{memberNo}
		   and attend_reg_date>date_format(curdate(),'%Y-%m-%d') 	
		) as success 
<!-- 		select count(*)
		  from tb_attendance
		 where member_no = #{memberNo}
		   and attend_reg_date>date_format(curdate(),'%Y-%m-%d') -->
	</select>
	
	<!-- 입실 등록 -->
	<insert id="insertCheckIn" parameterType="attend" useGeneratedKeys="true" keyProperty="attendNo">
		insert into tb_attendance(member_no, check_in)
		values(#{memberNo},now())
	</insert>
	
	<!-- 입실 수정 -->
	<update id="updateAttendance" parameterType="int">
		update tb_attendance
		   set code_no = 20
		 where attend_no = #{attendNo}
	</update>
	
	<!-- 퇴실 등록 -->
	<insert id="insertCheckOut" parameterType="attend">
		insert into tb_attendance(member_no, check_out)
		values(#{memberNo},now())
	</insert>
	
	<!-- 일별 전체 인원 count -->
	<select id="selectAllCount" parameterType="attend" resultType="int">
		select count(*)
		  from tb_attendance
		 where a.attend_reg_date>date_format(curdate(),'%Y-%m-%d')
	</select>
	
	<!-- 일별 출석인원 count-->
	<select id="selectAttendCount" parameterType="int" >
		select count(code_no)
		  from tb_attendance
         where code_no = 20
	</select>
	
</mapper>